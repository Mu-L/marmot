<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marmot Admin Dashboard</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100">
    <div x-data="adminApp()" x-init="init()" x-cloak class="min-h-screen">
        <!-- Login Screen -->
        <template x-if="!authenticated">
            <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
                <div class="max-w-md w-full space-y-8">
                    <div>
                        <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">Marmot Admin Dashboard</h2>
                        <p class="mt-2 text-center text-sm text-gray-600">Enter your Pre-Shared Key to access the admin panel</p>
                    </div>
                    <form class="mt-8 space-y-6" @submit.prevent="login">
                        <div class="rounded-md shadow-sm -space-y-px">
                            <input type="password" x-model="psk" class="appearance-none rounded relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Pre-Shared Key (leave empty if not required)">
                        </div>
                        <div x-show="loginError" class="text-red-500 text-sm text-center" x-text="loginError"></div>
                        <button type="submit" :disabled="loggingIn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">
                            <span x-show="loggingIn" class="loading-spinner mr-2"></span>
                            <span x-text="loggingIn ? 'Authenticating...' : 'Sign in'"></span>
                        </button>
                    </form>
                </div>
            </div>
        </template>

        <!-- Main Dashboard -->
        <template x-if="authenticated">
            <div class="min-h-screen">
                <!-- Navigation -->
                <nav class="bg-indigo-800">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between h-16">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 text-white font-bold text-xl">Marmot Admin</div>
                                <div class="hidden md:block ml-10">
                                    <div class="flex items-baseline space-x-4">
                                        <template x-for="tab in ['overview', 'cluster', 'replication', 'transactions', 'intents']" :key="tab">
                                            <button @click="setActiveTab(tab)"
                                                :class="activeTab === tab ? 'bg-indigo-700 text-white' : 'text-indigo-300 hover:bg-indigo-700 hover:text-white'"
                                                class="px-3 py-2 rounded-md text-sm font-medium capitalize" x-text="tab"></button>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="text-white text-sm">
                                    Database:
                                    <select x-model="selectedDatabase" @change="loadStats()" class="bg-indigo-700 text-white rounded px-2 py-1 ml-1">
                                        <template x-for="db in databases" :key="db.name">
                                            <option :value="db.name" x-text="db.name"></option>
                                        </template>
                                    </select>
                                </span>
                                <button @click="logout" class="text-indigo-200 hover:text-white text-sm">Logout</button>
                            </div>
                        </div>
                    </div>
                </nav>

                <!-- Main Content -->
                <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                    <!-- Overview Tab -->
                    <div x-show="activeTab === 'overview'" class="px-4 py-6 sm:px-0">
                        <!-- Cluster Health Banner -->
                        <div class="mb-6 rounded-lg p-4" :class="clusterHealth.healthy ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg x-show="clusterHealth.healthy" class="h-8 w-8 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        <svg x-show="!clusterHealth.healthy" class="h-8 w-8 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium" :class="clusterHealth.healthy ? 'text-green-800' : 'text-red-800'">
                                            Cluster Status: <span x-text="clusterHealth.healthy ? 'Healthy' : 'Unhealthy'"></span>
                                        </h3>
                                        <div class="mt-1 text-sm" :class="clusterHealth.healthy ? 'text-green-700' : 'text-red-700'">
                                            <span x-text="clusterHealth.alive_nodes"></span>/<span x-text="clusterHealth.total_nodes"></span> nodes alive
                                            (quorum: <span x-text="clusterHealth.quorum_size"></span>)
                                        </div>
                                    </div>
                                </div>
                                <div class="text-sm" :class="clusterHealth.healthy ? 'text-green-600' : 'text-red-600'">
                                    Local Node: <span x-text="clusterHealth.local_node_id"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Cards -->
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
                            <template x-for="card in [
                                {label: 'Max Committed Txn ID', value: stats.max_committed_txn_id, color: 'indigo'},
                                {label: 'Committed Transactions', value: stats.committed_txn_count, color: 'green'},
                                {label: 'Pending Transactions', value: stats.pending_txns, color: 'yellow'},
                                {label: 'Intent Filter Size', value: stats.intent_filter_size, color: 'purple'}
                            ]" :key="card.label">
                                <div class="bg-white overflow-hidden shadow rounded-lg">
                                    <div class="px-4 py-5 sm:p-6">
                                        <div class="flex items-center">
                                            <div :class="'bg-' + card.color + '-500'" class="flex-shrink-0 rounded-md p-3">
                                                <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                </svg>
                                            </div>
                                            <div class="ml-5 w-0 flex-1">
                                                <dt class="text-sm font-medium text-gray-500 truncate" x-text="card.label"></dt>
                                                <dd class="text-2xl font-semibold text-gray-900" x-text="formatNumber(card.value)"></dd>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Databases List -->
                        <div class="mt-8 bg-white shadow overflow-hidden sm:rounded-lg">
                            <div class="px-4 py-5 sm:px-6">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">Databases</h3>
                            </div>
                            <div class="border-t border-gray-200">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">File Size</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Max Txn ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Txn Count</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Modified</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="db in databases" :key="db.name">
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="db.name"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatBytes(db.file_size)"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatNumber(db.max_txn_id)"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatNumber(db.txn_count)"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="db.last_modified"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Cluster Tab -->
                    <div x-show="activeTab === 'cluster'" class="px-4 py-6 sm:px-0">
                        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                            <div class="px-4 py-5 sm:px-6">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">Cluster Members</h3>
                            </div>
                            <div class="border-t border-gray-200">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Node ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Address</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Incarnation</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Flags</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="member in clusterMembers" :key="member.node_id">
                                            <tr @click="showDetail('Node ' + member.node_id, member)" class="cursor-pointer hover:bg-gray-50">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="member.node_id"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="member.address"></td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                          :class="{
                                                            'bg-green-100 text-green-800': member.status === 'ALIVE',
                                                            'bg-yellow-100 text-yellow-800': member.status === 'JOINING' || member.status === 'SUSPECT',
                                                            'bg-red-100 text-red-800': member.status === 'DEAD',
                                                            'bg-gray-100 text-gray-800': member.status === 'REMOVED'
                                                          }" x-text="member.status"></span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                          :class="member.role === 'seed' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'"
                                                          x-text="member.role || 'member'"></span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="member.incarnation"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    <span x-show="member.is_local" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800 mr-1">LOCAL</span>
                                                    <span x-show="member.is_seed" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">SEED</span>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Replication Tab -->
                    <div x-show="activeTab === 'replication'" class="px-4 py-6 sm:px-0">
                        <!-- Watermark Info -->
                        <div class="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-2">
                            <div class="bg-white overflow-hidden shadow rounded-lg p-4">
                                <dt class="text-sm font-medium text-gray-500">Local Watermark</dt>
                                <dd class="mt-1 text-2xl font-semibold text-gray-900" x-text="formatNumber(replicationStatus.local_watermark)"></dd>
                            </div>
                            <div class="bg-white overflow-hidden shadow rounded-lg p-4">
                                <dt class="text-sm font-medium text-gray-500">Cluster Min Watermark</dt>
                                <dd class="mt-1 text-2xl font-semibold text-gray-900" x-text="formatNumber(replicationStatus.cluster_min_watermark)"></dd>
                            </div>
                        </div>

                        <!-- Peer Replication Status -->
                        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                            <div class="px-4 py-5 sm:px-6">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">Peer Replication Status</h3>
                            </div>
                            <div class="border-t border-gray-200">
                                <template x-if="replicationStatus.peers && replicationStatus.peers.length > 0">
                                    <div class="divide-y divide-gray-200">
                                        <template x-for="peer in replicationStatus.peers" :key="peer.node_id">
                                            <div class="px-4 py-4">
                                                <div class="flex items-center justify-between mb-2">
                                                    <div class="flex items-center">
                                                        <span class="font-medium text-gray-900">Node <span x-text="peer.node_id"></span></span>
                                                        <span class="ml-2 text-sm text-gray-500" x-text="peer.address"></span>
                                                        <span class="ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                              :class="{
                                                                'bg-green-100 text-green-800': peer.status === 'ALIVE',
                                                                'bg-yellow-100 text-yellow-800': peer.status === 'SUSPECT',
                                                                'bg-red-100 text-red-800': peer.status === 'DEAD'
                                                              }" x-text="peer.status"></span>
                                                    </div>
                                                </div>
                                                <table class="min-w-full divide-y divide-gray-200 mt-2">
                                                    <thead class="bg-gray-50">
                                                        <tr>
                                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Database</th>
                                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Last Applied Txn</th>
                                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Lag</th>
                                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Sync Status</th>
                                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Last Sync</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="bg-white divide-y divide-gray-200">
                                                        <template x-for="db in peer.databases" :key="db.database">
                                                            <tr>
                                                                <td class="px-4 py-2 text-sm font-medium text-gray-900" x-text="db.database"></td>
                                                                <td class="px-4 py-2 text-sm text-gray-500" x-text="formatNumber(db.last_applied_txn_id)"></td>
                                                                <td class="px-4 py-2 text-sm">
                                                                    <span :class="db.lag_txns > 100 ? 'text-red-600 font-semibold' : db.lag_txns > 10 ? 'text-yellow-600' : 'text-green-600'"
                                                                          x-text="formatNumber(db.lag_txns)"></span>
                                                                </td>
                                                                <td class="px-4 py-2">
                                                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                                          :class="{
                                                                            'bg-green-100 text-green-800': db.sync_status === 'SYNCED',
                                                                            'bg-yellow-100 text-yellow-800': db.sync_status === 'CATCHING_UP',
                                                                            'bg-red-100 text-red-800': db.sync_status === 'FAILED',
                                                                            'bg-gray-100 text-gray-800': db.sync_status === 'UNKNOWN'
                                                                          }" x-text="db.sync_status"></span>
                                                                </td>
                                                                <td class="px-4 py-2 text-sm text-gray-500" x-text="db.last_sync_time || 'Never'"></td>
                                                            </tr>
                                                        </template>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                                <div x-show="!replicationStatus.peers || replicationStatus.peers.length === 0" class="text-center py-12">
                                    <p class="text-gray-500">No peer replication data available (single node cluster)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transactions Tab -->
                    <div x-show="activeTab === 'transactions'" class="px-4 py-6 sm:px-0">
                        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                            <div class="px-4 py-5 sm:px-6">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">Transaction Data</h3>
                                <div class="mt-2 flex space-x-2">
                                    <template x-for="status in ['pending', 'committed', 'aborted', 'all']" :key="status">
                                        <button @click="loadTransactions(status)"
                                            :class="transactionsType === status ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'"
                                            class="px-3 py-2 text-sm font-medium rounded-md capitalize" x-text="status"></button>
                                    </template>
                                </div>
                            </div>
                            <div class="border-t border-gray-200">
                                <div x-show="loading" class="flex justify-center items-center py-12">
                                    <div class="loading-spinner"></div>
                                </div>
                                <template x-if="!loading && transactions.length > 0">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Txn ID</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Node ID</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created At</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <template x-for="(txn, idx) in transactions" :key="txn.txn_id + '-' + idx">
                                                <tr class="hover:bg-gray-50">
                                                    <td @click="showDetail('Transaction ' + txn.txn_id, txn)" class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 cursor-pointer" x-text="txn.txn_id"></td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="txn.node_id"></td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                              :class="{
                                                                'bg-yellow-100 text-yellow-800': txn.status === 'PENDING',
                                                                'bg-green-100 text-green-800': txn.status === 'COMMITTED',
                                                                'bg-red-100 text-red-800': txn.status === 'ABORTED'
                                                              }" x-text="txn.status"></span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="txn.created_at || 'N/A'"></td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                        <button x-show="txn.status === 'PENDING'"
                                                                @click.stop="abortTransaction(txn.txn_id)"
                                                                :disabled="abortingTxn === txn.txn_id"
                                                                class="text-red-600 hover:text-red-900 disabled:opacity-50">
                                                            <span x-show="abortingTxn === txn.txn_id" class="loading-spinner mr-1"></span>
                                                            <span x-text="abortingTxn === txn.txn_id ? 'Aborting...' : 'Abort'"></span>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </template>
                                <div x-show="!loading && transactions.length === 0" class="text-center py-12">
                                    <p class="text-gray-500">No transactions found</p>
                                </div>
                                <div x-show="!loading && transactionsHasMore" class="px-6 py-4 border-t border-gray-200">
                                    <button @click="loadMoreTransactions()" :disabled="loadingMore" class="w-full px-4 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 rounded-md hover:bg-indigo-100 disabled:opacity-50 flex items-center justify-center">
                                        <span x-show="loadingMore" class="loading-spinner mr-2"></span>
                                        <span x-text="loadingMore ? 'Loading...' : 'Load More'"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Intents Tab -->
                    <div x-show="activeTab === 'intents'" class="px-4 py-6 sm:px-0">
                        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                            <div class="px-4 py-5 sm:px-6">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">Write Intents</h3>
                                <div class="mt-2 flex space-x-4">
                                    <input type="text" x-model="intentTableFilter" placeholder="Table name (e.g. benchmarks)..." class="block w-full pl-3 pr-10 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <button @click="loadIntents()" class="px-4 py-2 text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Search</button>
                                </div>
                            </div>
                            <div class="border-t border-gray-200">
                                <div x-show="loading" class="flex justify-center items-center py-12">
                                    <div class="loading-spinner"></div>
                                </div>
                                <template x-if="!loading && intents.length > 0">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Table</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Row Key</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Txn ID</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Operation</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <template x-for="(intent, idx) in intents" :key="intent.table_name + ':' + intent.row_key + '-' + idx">
                                                <tr @click="showDetail('Intent: ' + intent.table_name + '/' + intent.row_key, intent)" class="cursor-pointer hover:bg-gray-50">
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="intent.table_name"></td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="intent.row_key"></td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="intent.txn_id"></td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="intent.operation"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </template>
                                <div x-show="!loading && intents.length === 0" class="text-center py-12">
                                    <p class="text-gray-500">No intents found</p>
                                </div>
                                <div x-show="!loading && intentsHasMore" class="px-6 py-4 border-t border-gray-200">
                                    <button @click="loadMoreIntents()" :disabled="loadingMore" class="w-full px-4 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 rounded-md hover:bg-indigo-100 disabled:opacity-50 flex items-center justify-center">
                                        <span x-show="loadingMore" class="loading-spinner mr-2"></span>
                                        <span x-text="loadingMore ? 'Loading...' : 'Load More'"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>

                <!-- Detail Modal (inside authenticated block) -->
                <template x-if="showDetailModal">
                    <div class="fixed inset-0 z-50 overflow-y-auto" @keydown.escape.window="closeDetail()">
                        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
                            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="closeDetail()"></div>
                            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
                                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-lg font-medium text-gray-900" x-text="detailTitle"></h3>
                                        <button @click="closeDetail()" class="text-gray-400 hover:text-gray-600">
                                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <pre class="bg-gray-800 text-green-400 p-4 rounded-lg overflow-auto max-h-96 text-sm font-mono" x-text="formatJSON(detailData)"></pre>
                                </div>
                                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                    <button @click="closeDetail()" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:ml-3 sm:w-auto sm:text-sm">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </template>
    </div>

    <script>
        function adminApp() {
            return {
                // Auth state
                authenticated: false,
                psk: '',
                loggingIn: false,
                loginError: '',

                // UI state
                activeTab: 'overview',
                selectedDatabase: 'marmot',
                databases: [],
                loading: false,

                // Data
                stats: { max_committed_txn_id: 0, committed_txn_count: 0, pending_txns: 0, intent_filter_size: 0, max_seq_num: 0 },
                clusterMembers: [],
                clusterHealth: { healthy: true, total_nodes: 0, alive_nodes: 0, quorum_size: 0, local_node_id: 0 },
                replicationStatus: { peers: [], local_watermark: 0, cluster_min_watermark: 0 },
                transactions: [],
                intents: [],

                // Filters
                intentTableFilter: '',

                // Detail modal
                showDetailModal: false,
                detailTitle: '',
                detailData: null,

                // Pagination
                transactionsHasMore: false,
                transactionsLastKey: '',
                transactionsType: 'pending',
                intentsHasMore: false,
                intentsLastKey: '',
                loadingMore: false,

                // Abort state
                abortingTxn: null,

                init() {
                    const savedPsk = localStorage.getItem('marmot_psk');
                    if (savedPsk) {
                        this.psk = savedPsk;
                        this.authenticated = true;
                        this.loadData();
                    }
                },

                getHeaders() {
                    return this.psk ? { 'X-Marmot-Secret': this.psk } : {};
                },

                async login() {
                    this.loggingIn = true;
                    this.loginError = '';

                    try {
                        const response = await fetch('/admin/cluster/members', {
                            headers: this.getHeaders()
                        });

                        if (response.ok) {
                            this.authenticated = true;
                            if (this.psk) {
                                localStorage.setItem('marmot_psk', this.psk);
                            } else {
                                localStorage.removeItem('marmot_psk');
                            }
                            await this.loadData();
                        } else {
                            this.loginError = 'Invalid Pre-Shared Key';
                        }
                    } catch (error) {
                        this.loginError = 'Authentication failed';
                    } finally {
                        this.loggingIn = false;
                    }
                },

                logout() {
                    this.authenticated = false;
                    this.psk = '';
                    localStorage.removeItem('marmot_psk');
                },

                setActiveTab(tab) {
                    this.activeTab = tab;
                    if (tab === 'cluster') this.loadClusterMembers();
                    else if (tab === 'replication') this.loadReplicationStatus();
                    else if (tab === 'transactions') this.loadTransactions('pending');
                    else if (tab === 'intents') this.loadIntents();
                    else if (tab === 'overview') {
                        this.loadStats();
                        this.loadClusterHealth();
                    }
                },

                async loadData() {
                    await Promise.all([
                        this.loadDatabases(),
                        this.loadStats(),
                        this.loadClusterMembers(),
                        this.loadClusterHealth()
                    ]);
                },

                async loadDatabases() {
                    try {
                        const response = await fetch('/admin/databases', {
                            headers: this.getHeaders()
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.databases = data.data || [];
                            if (this.databases.length > 0 && !this.databases.find(db => db.name === this.selectedDatabase)) {
                                this.selectedDatabase = this.databases[0].name;
                            }
                        }
                    } catch (error) {
                        console.error('Failed to load databases:', error);
                        this.databases = [{ name: 'marmot', file_size: 0, max_txn_id: 0, txn_count: 0 }];
                    }
                },

                async loadStats() {
                    try {
                        const response = await fetch(`/admin/${this.selectedDatabase}/metadata/stats`, {
                            headers: this.getHeaders()
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.stats = data.data || this.stats;
                        }
                    } catch (error) {
                        console.error('Failed to load stats:', error);
                    }
                },

                async loadClusterMembers() {
                    try {
                        const response = await fetch('/admin/cluster/members', {
                            headers: this.getHeaders()
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.clusterMembers = data.data || [];
                        }
                    } catch (error) {
                        console.error('Failed to load cluster members:', error);
                    }
                },

                async loadClusterHealth() {
                    try {
                        const response = await fetch('/admin/cluster/health', {
                            headers: this.getHeaders()
                        });
                        if (response.ok || response.status === 503) {
                            const data = await response.json();
                            this.clusterHealth = data.data || this.clusterHealth;
                        }
                    } catch (error) {
                        console.error('Failed to load cluster health:', error);
                    }
                },

                async loadReplicationStatus() {
                    try {
                        const response = await fetch('/admin/cluster/replication', {
                            headers: this.getHeaders()
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.replicationStatus = data.data || this.replicationStatus;
                        }
                    } catch (error) {
                        console.error('Failed to load replication status:', error);
                    }
                },

                async loadTransactions(type, append = false) {
                    if (append) {
                        this.loadingMore = true;
                    } else {
                        this.loading = true;
                        this.transactionsType = type;
                        this.transactionsLastKey = '';
                    }
                    try {
                        let url = `/admin/${this.selectedDatabase}/metadata/transactions/status/${type}`;
                        if (append && this.transactionsLastKey) {
                            url += `?from=${this.transactionsLastKey}`;
                        }
                        const response = await fetch(url, {
                            headers: this.getHeaders()
                        });
                        if (response.ok) {
                            const data = await response.json();
                            const newData = Array.isArray(data.data) ? data.data : [];
                            if (append) {
                                this.transactions = [...this.transactions, ...newData];
                            } else {
                                this.transactions = newData;
                            }
                            this.transactionsHasMore = data.has_more || false;
                            this.transactionsLastKey = data.last_key || '';
                        } else {
                            if (!append) this.transactions = [];
                        }
                    } catch (error) {
                        console.error('Failed to load transactions:', error);
                        if (!append) this.transactions = [];
                    } finally {
                        this.loading = false;
                        this.loadingMore = false;
                    }
                },

                loadMoreTransactions() {
                    this.loadTransactions(this.transactionsType, true);
                },

                async abortTransaction(txnId) {
                    if (!confirm(`Are you sure you want to abort transaction ${txnId}?`)) {
                        return;
                    }

                    this.abortingTxn = txnId;
                    try {
                        const response = await fetch(`/admin/${this.selectedDatabase}/transactions/${txnId}/abort`, {
                            method: 'POST',
                            headers: {
                                ...this.getHeaders(),
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ reason: 'Aborted via admin UI' })
                        });

                        if (response.ok) {
                            // Refresh transactions list
                            await this.loadTransactions(this.transactionsType);
                        } else {
                            const data = await response.json();
                            alert(`Failed to abort transaction: ${data.error || 'Unknown error'}`);
                        }
                    } catch (error) {
                        console.error('Failed to abort transaction:', error);
                        alert('Failed to abort transaction');
                    } finally {
                        this.abortingTxn = null;
                    }
                },

                async loadIntents(append = false) {
                    if (append) {
                        this.loadingMore = true;
                    } else {
                        this.loading = true;
                        this.intentsLastKey = '';
                    }
                    try {
                        const table = this.intentTableFilter || 'benchmarks';
                        let url = `/admin/${this.selectedDatabase}/metadata/intents/table/${table}`;
                        if (append && this.intentsLastKey) {
                            url += `?from=${this.intentsLastKey}`;
                        }
                        const response = await fetch(url, {
                            headers: this.getHeaders()
                        });
                        if (response.ok) {
                            const data = await response.json();
                            const newData = Array.isArray(data.data) ? data.data : [];
                            if (append) {
                                this.intents = [...this.intents, ...newData];
                            } else {
                                this.intents = newData;
                            }
                            this.intentsHasMore = data.has_more || false;
                            this.intentsLastKey = data.last_key || '';
                        } else {
                            if (!append) this.intents = [];
                        }
                    } catch (error) {
                        console.error('Failed to load intents:', error);
                        if (!append) this.intents = [];
                    } finally {
                        this.loading = false;
                        this.loadingMore = false;
                    }
                },

                loadMoreIntents() {
                    this.loadIntents(true);
                },

                formatNumber(num) {
                    if (num === undefined || num === null) return '0';
                    return num.toLocaleString();
                },

                formatBytes(bytes) {
                    if (!bytes) return '0 B';
                    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                    let i = 0;
                    while (bytes >= 1024 && i < units.length - 1) {
                        bytes /= 1024;
                        i++;
                    }
                    return bytes.toFixed(i > 0 ? 1 : 0) + ' ' + units[i];
                },

                formatTimestamp(timestamp) {
                    if (!timestamp) return 'N/A';
                    return new Date(timestamp / 1000000).toISOString();
                },

                showDetail(title, data) {
                    this.detailTitle = title;
                    this.detailData = data;
                    this.showDetailModal = true;
                },

                closeDetail() {
                    this.showDetailModal = false;
                    this.detailData = null;
                },

                formatJSON(data) {
                    return JSON.stringify(data, null, 2);
                }
            };
        }
    </script>
</body>
</html>
