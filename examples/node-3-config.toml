# Marmot v2.0 - Example Node 3
# Full Database Replication

node_id = 3
data_dir = "/tmp/marmot-node-3"

[transaction]
heartbeat_timeout_seconds = 10
conflict_window_seconds = 10
lock_wait_timeout_seconds = 50  # How long to wait for locks (MySQL: innodb_lock_wait_timeout)

[cluster]
grpc_bind_address = "0.0.0.0"
grpc_advertise_address = "localhost:8083"
grpc_port = 8083
seed_nodes = ["localhost:8081", "localhost:8082"]
gossip_interval_ms = 1000
gossip_fanout = 2
suspect_timeout_ms = 5000
dead_timeout_ms = 10000

[replication]
default_write_consistency = "QUORUM"
default_read_consistency = "LOCAL_ONE"
write_timeout_ms = 300000
read_timeout_ms = 2000

# Anti-Entropy: Background healing for eventual consistency
# - Detects and repairs divergence between replicas
# - Uses delta sync for small lags, snapshot for large lags
# - Includes gap detection to prevent incomplete data after GC
enable_anti_entropy = true
anti_entropy_interval_seconds = 30         # Check every 30 seconds (provides fresh watermarks for GC)
gc_interval_seconds = 60                   # GC runs every 60s (MUST be >= anti_entropy_interval)
delta_sync_threshold_transactions = 10000  # Delta sync if lag < 10K txns
delta_sync_threshold_seconds = 3600        # Snapshot if lag > 1 hour

# Garbage Collection: Reclaim disk space
# - gc_min must be >= delta_sync_threshold (validated at startup)
# - gc_max should be >= 2x delta_sync_threshold (recommended)
# - Set gc_max = 0 for unlimited retention
gc_min_retention_hours = 2   # Keep at least 2 hours (>= 1 hour delta threshold)
gc_max_retention_hours = 24  # Force delete after 24 hours

[connection_pool]
pool_size = 4
max_idle_time_seconds = 10
max_lifetime_seconds = 300

[grpc_client]
keepalive_time_seconds = 10
keepalive_timeout_seconds = 3
max_retries = 3
retry_backoff_ms = 100
compression_level = 1  # zstd: 0=disabled, 1=fastest, 4=best

[coordinator]
prepare_timeout_ms = 120000
commit_timeout_ms = 120000
abort_timeout_ms = 2000

[query_pipeline]
transpiler_cache_size = 10000       # LRU cache for MySQLâ†’SQLite transpilation (default: 10000)
validator_pool_size = 8             # SQLite connection pool for validation (default: 8)

[mysql]
enabled = true
bind_address = "0.0.0.0"
port = 3309
max_connections = 100
auto_id_mode = "compact"

# PebbleDB metastore (CockroachDB-tested defaults)
[metastore]
cache_size_mb = 128
memtable_size_mb = 64
memtable_count = 2
l0_compaction_threshold = 500
l0_stop_writes = 1000
wal_bytes_per_sync_kb = 512

[logging]
verbose = false
format = "json"
# file = "/tmp/marmot/logs/marmot.log"  # Uncomment to enable file logging
# max_size_mb = 100                       # Max size before rotation (default: 100)
# max_backups = 5                         # Number of old log files to keep (default: 5)
# compress = true                         # Compress rotated files (default: true)

[prometheus]
# Metrics served on gRPC port at http://localhost:8083/metrics
enabled = true

[batch_commit]
enabled = true
max_batch_size = 100
max_wait_ms = 1
checkpoint_enabled = true
checkpoint_passive_thresh_mb = 4.0
checkpoint_restart_thresh_mb = 16.0
allow_dynamic_batch_size = true

# CDC Publisher - Stream changes to external systems (Kafka, NATS)
# Events follow Debezium specification: https://debezium.io/
[publisher]
enabled = false  # Set to true to enable CDC publishing

# Example Kafka sink configuration (uncomment to enable):
# [[publisher.sinks]]
# name = "kafka-main"
# type = "kafka"
# format = "debezium"
# brokers = ["localhost:9092"]
# topic_prefix = "marmot.cdc"
# filter_tables = ["*"]
# filter_databases = ["*"]
# batch_size = 100
# poll_interval_ms = 10
