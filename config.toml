# Marmot v2.0 Configuration
# Leaderless SQLite Replication with MVCC

# ==============================================================================
# NODE IDENTITY
# ==============================================================================

# Unique identifier for this node (0 = auto-generate from machine ID)
node_id = 0

# Directory for node data (logs, state, etc.)
# Place existing SQLite .db files here - they will be imported on first startup
data_dir = "./marmot-data"

# ==============================================================================
# MVCC (Multi-Version Concurrency Control)
# ==============================================================================

[mvcc]
# Garbage collection interval (seconds)
gc_interval_seconds = 30

# How long to retain old transaction records (hours)
gc_retention_hours = 2

# Transaction timeout without heartbeat (seconds)
heartbeat_timeout_seconds = 10

# Number of MVCC versions to keep per row
version_retention_count = 10

# Time window for Last-Write-Wins conflict resolution (seconds)
conflict_window_seconds = 10

# ==============================================================================
# CLUSTER MEMBERSHIP
# ==============================================================================

[cluster]
# Address to bind gRPC server (0.0.0.0 = all interfaces)
grpc_bind_address = "0.0.0.0"

# Address other nodes use to connect to this node
# Leave empty to auto-detect (hostname:grpc_port)
# Override for NAT/Docker: "public-ip:8080" or "service-name:8080"
grpc_advertise_address = ""

# gRPC port for cluster communication
grpc_port = 8080

# List of seed nodes to join cluster (empty = start as first node)
# Example: ["node1.example.com:8080", "node2.example.com:8080"]
seed_nodes = []

# Cluster authentication secret (PSK)
# All nodes in the cluster must use the same secret
# Can also be set via MARMOT_CLUSTER_SECRET environment variable (takes precedence)
# Leave empty to disable authentication (NOT recommended for production)
cluster_secret = ""

# Gossip protocol interval (milliseconds)
gossip_interval_ms = 1000

# Number of random peers to gossip with each round
gossip_fanout = 3

# Time before marking unresponsive node as suspect (milliseconds)
suspect_timeout_ms = 5000

# Time before declaring suspect node as dead (milliseconds)
dead_timeout_ms = 10000

# ==============================================================================
# REPLICATION
# ==============================================================================

[replication]
# Default write consistency level
# Options: ONE, TWO, THREE, QUORUM, ALL, LOCAL_ONE
default_write_consistency = "QUORUM"

# Default read consistency level
default_read_consistency = "LOCAL_ONE"

# Timeout for write operations (milliseconds)
write_timeout_ms = 5000

# Timeout for read operations (milliseconds)
read_timeout_ms = 2000

# Enable anti-entropy background sync
# Automatically catches up lagging nodes by replaying missed transactions
enable_anti_entropy = true

# Anti-entropy sync interval (seconds)
# How often to check for and repair replication lag (default: 60 = 1 minute)
anti_entropy_interval_seconds = 60

# Delta sync threshold (transactions)
# If a node lags by more than this many transactions, use snapshot instead of delta sync
delta_sync_threshold_transactions = 10000

# Delta sync threshold (seconds)
# If a node lags by more than this duration, use snapshot instead of delta sync
delta_sync_threshold_seconds = 3600

# Minimum GC retention (hours)
# Transaction logs kept for at least this long to support replication catch-up
# Must be >= delta_sync_threshold_seconds / 3600
gc_min_retention_hours = 2

# Maximum GC retention (hours)
# Force GC after this duration even if peers lagging (prevents unbounded growth)
gc_max_retention_hours = 24

# ==============================================================================
# CONNECTION POOL
# ==============================================================================

[connection_pool]
# Number of connections per pool
pool_size = 4

# Maximum idle time for connections (seconds)
max_idle_time_seconds = 10

# Maximum lifetime for connections (seconds)
max_lifetime_seconds = 300

# ==============================================================================
# GRPC CLIENT
# ==============================================================================

[grpc_client]
# Send keepalive ping every N seconds
keepalive_time_seconds = 10

# Timeout for keepalive ping response (seconds)
keepalive_timeout_seconds = 3

# Maximum retry attempts for failed requests
max_retries = 3

# Backoff duration between retries (milliseconds)
retry_backoff_ms = 100

# ==============================================================================
# TRANSACTION COORDINATOR
# ==============================================================================

[coordinator]
# Timeout for 2PC prepare phase (milliseconds)
prepare_timeout_ms = 2000

# Timeout for 2PC commit phase (milliseconds)
commit_timeout_ms = 2000

# Timeout for 2PC abort phase (milliseconds)
abort_timeout_ms = 2000

# ==============================================================================
# DDL REPLICATION
# ==============================================================================

[ddl]
# DDL lock lease duration (seconds)
# Prevents concurrent DDL operations on the same database across the cluster
# If a node crashes while holding a DDL lock, the lock expires after this duration
lock_lease_seconds = 30

# Automatically rewrite DDL for idempotency
# Converts "CREATE TABLE foo" to "CREATE TABLE IF NOT EXISTS foo", etc.
# This allows safe replay of DDL operations after failures or during catch-up
enable_idempotent = true

# ==============================================================================
# MYSQL PROTOCOL SERVER
# ==============================================================================

[mysql]
# Enable MySQL wire protocol server
enabled = true

# Address to bind MySQL server (0.0.0.0 = all interfaces)
bind_address = "127.0.0.1"

# MySQL protocol port
port = 3307

# Maximum concurrent MySQL connections
max_connections = 1000

# ==============================================================================
# SNAPSHOT (Not yet implemented)
# ==============================================================================

[snapshot]
# Enable periodic snapshots
enabled = false

# Snapshot interval (seconds)
interval_seconds = 300

# Snapshot storage type: peer, s3, webdav, sftp, local
store = "peer"

# Snapshot chunk size (MB)
chunk_size_mb = 5

# Number of parallel chunks for snapshot transfer
parallel_chunks = 5

# Number of changes before triggering full snapshot
incremental_threshold = 10000

# ==============================================================================
# LOGGING
# ==============================================================================

[logging]
# Enable verbose debug logging
verbose = false

# Log format: "console" (human-readable) or "json" (structured)
format = "console"

# ==============================================================================
# METRICS
# ==============================================================================

[prometheus]
# Enable Prometheus metrics endpoint
enabled = false

# Address to bind metrics server
address = "0.0.0.0"

# Prometheus metrics port
port = 9090
